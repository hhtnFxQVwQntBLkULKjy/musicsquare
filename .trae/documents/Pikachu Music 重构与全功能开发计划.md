# 最终后端与同步功能实现计划

我已完全理解您的需求。我们将实现一个**“基于个人主页链接”**的同步方案，这最符合您描述的“去网页版登录 -> 获取数据 -> 同步”的流程，同时符合浏览器安全规范。

## 1. 数据库与后端设计 (`backend/`)

我们将构建一个强大的单文件后端 `worker.js`，支持完整的数据隔离和同步逻辑。

### 1.1 数据库表结构 (`schema.sql`)
我们将创建以下表来满足所有存储需求：
1.  **Users**: `id`, `username`, `password`, `avatar` (用户头像), `created_at`。
2.  **Play_History**: `user_id`, `song_json`, `played_at` (记录最近播放)。
3.  **Synced_Accounts**: `user_id`, `platform`, `external_user_id` (记录已同步的平台账号)。
4.  **Playlists**: 
    *   `id`, `user_id`, `name`
    *   `is_sync` (是否为同步歌单: 0/1)
    *   `platform` (来源: 'netease', 'qq'...)
    *   `external_id` (外部歌单ID)
    *   `can_delete` (同步歌单不可删除: 0/1)
5.  **Playlist_Songs**: `playlist_id`, `song_json`。
6.  **Favorites**: `user_id`, `song_json` (本地收藏)。

### 1.2 后端逻辑 (`worker.js`)
*   **Auth**: 注册/登录 (数据隔离)。
*   **Sync API (`/api/sync`)**:
    *   **输入**: 平台类型 + **用户个人主页链接** (例如 `https://music.163.com/#/user/home?id=xxx`)。
    *   **逻辑**: 
        1.  解析链接获取 User ID。
        2.  调用 Meting API 拉取该用户所有歌单（包括“喜欢的音乐”）。
        3.  **全量更新策略**: 检查 DB 是否已存在该平台数据 -> 存在则删除该用户该平台所有旧歌单 -> 插入最新拉取的全量歌单。
*   **Data API**: 处理本地歌单的增删改查、收藏、历史记录。

## 2. 前端功能实现 (`js/`)

### 2.1 同步弹窗 (Sync Modal)
按照您的描述重构弹窗：
1.  **选择平台**: 显示 网易/QQ/咪咕/酷我 图标。
2.  **跳转登录**: 点击图标 -> 新窗口打开对应官方网页版 (让用户登录)。
3.  **输入链接**: 提示用户“登录后点击个人头像进入主页，复制浏览器地址栏链接”。
4.  **执行同步**: 粘贴链接 -> 点击“同步” -> 后端处理。

### 2.2 侧边栏与数据展示
*   **我的歌单**: 本地创建的歌单（支持右键删除/重命名）。
*   **同步歌单**: 
    *   按平台折叠展示 (例如 "网易云音乐 [已同步]").
    *   使用箭头图标展开/折叠。
    *   **只读模式**: 右键菜单禁用删除/重命名，仅允许播放。
*   **收藏与历史**:
    *   从后端拉取并展示。

## 3. 执行步骤

1.  **Step 1**: 更新 `backend/schema.sql` (包含所有新表)。
2.  **Step 2**: 编写 `backend/worker.js` (包含 Auth, Sync, CRUD 逻辑)。
3.  **Step 3**: 更新前端 `js/service.js` 和 `js/ui.js` 适配新后端和同步流程。
4.  **Step 4**: 联调测试 (模拟同步网易云数据)。

我将直接开始编写代码。
